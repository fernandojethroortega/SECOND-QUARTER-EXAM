import React, { useState, useEffect, useRef } from "react";

// Default export component for preview. Tailwind CSS assumed available in host environment.
// This single-file React component implements:
// - Grade level dashboard (Grades 7-12)
// - Subjects grid per grade (English, Filipino, Mathematics, Araling Panlipunan, MAPEH, Science, TLE, ESP)
// - Teacher can upload a .txt or .docx exam file for a subject
// - The system reads the file, extracts questions (basic number-based parsing), and saves the exam
// - The system generates an online presentation: 1 question per slide, 60-second timer per slide
// - Auto-advance when timer ends; manual next/prev; pause/resume; fullscreen presentation option
// NOTE: This update fixes a runtime/build error related to importing the Mammoth library in
// some bundler environments. Instead of relying only on dynamic `import(...)` (which some
// bundlers rewrite and cause invalid URLs), this code first tries a dynamic import and
// falls back to injecting a script tag that provides `window.mammoth`.

export default function OnlineExamDashboard() {
  const gradeLevels = ["Grade 7", "Grade 8", "Grade 9", "Grade 10", "Grade 11", "Grade 12"];
  const subjects = [
    "English",
    "Filipino",
    "Mathematics",
    "Araling Panlipunan",
    "MAPEH",
    "Science",
    "TLE",
    "ESP",
  ];

  // exams state shape: { "Grade 7|English": { questions: ["...","..."], uploadedAt: Date } }
  const [exams, setExams] = useState(() => {
    try {
      const raw = localStorage.getItem("onlineExams_v1");
      return raw ? JSON.parse(raw) : {};
    } catch (e) {
      return {};
    }
  });

  const [selectedGrade, setSelectedGrade] = useState(gradeLevels[0]);
  const [selectedSubject, setSelectedSubject] = useState(subjects[0]);
  const [presenting, setPresenting] = useState(false);
  const [currentQuestions, setCurrentQuestions] = useState([]);
  const [currentIndex, setCurrentIndex] = useState(0);
  const [timeLeft, setTimeLeft] = useState(60);
  const [isPaused, setIsPaused] = useState(true);
  const timerRef = useRef(null);

  // persist exams to localStorage when changed
  useEffect(() => {
    localStorage.setItem("onlineExams_v1", JSON.stringify(exams));
  }, [exams]);

  // Clear interval on unmount
  useEffect(() => {
    return () => clearInterval(timerRef.current);
  }, []);

  // Timer effect
  useEffect(() => {
    if (!presenting) return;
    if (isPaused) return;

    timerRef.current = setInterval(() => {
      setTimeLeft((t) => t - 1);
    }, 1000);

    return () => clearInterval(timerRef.current);
  }, [presenting, isPaused]);

  // When timeLeft hits 0, move to next slide automatically
  useEffect(() => {
    if (!presenting) return;
    if (timeLeft <= 0) {
      handleNext();
    }
  }, [timeLeft]);

  function keyFor(grade, subject) {
    return `${grade}|${subject}`;
  }

  // Helper to inject script and wait for it to load
  function loadExternalScript(src, globalName) {
    return new Promise((resolve, reject) => {
      // If already available, resolve immediately
      if (globalName && window[globalName]) return resolve(window[globalName]);

      // Check if script already added
      const existing = Array.from(document.getElementsByTagName('script')).find(s => s.src === src);
      if (existing) {
        existing.addEventListener('load', () => resolve(window[globalName]));
        existing.addEventListener('error', () => reject(new Error('Failed to load script')));
        return;
      }

      const s = document.createElement('script');
      s.src = src;
      s.async = true;
      s.onload = () => {
        if (globalName && window[globalName]) return resolve(window[globalName]);
        return resolve(true);
      };
      s.onerror = () => reject(new Error(`Failed to load script: ${src}`));
      document.head.appendChild(s);
    });
  }

  async function handleFileUpload(file, grade, subject) {
    const key = keyFor(grade, subject);

    // support .txt and .docx
    const ext = file.name.split('.').pop().toLowerCase();

    let text = "";

    if (ext === "txt") {
      text = await file.text();
    } else if (ext === "docx") {
      // We prefer a dynamic import first. Some bundlers rewrite dynamic import() of
      // full URLs which leads to invalid urls (e.g. prefixing with another CDN).
      // To be robust, try import(...) and if that fails, fall back to injecting
      // the script from unpkg which exposes `window.mammoth`.
      try {
        // Correct, direct URL to mammoth's browser build on unpkg
        const mammothModule = await import("https://unpkg.com/mammoth/mammoth.browser.min.js");
        const arrayBuffer = await file.arrayBuffer();
        // mammothModule may be the module or it may be the global; mammoth's UMD build
        // provides a `convertToHtml` function either on default or on `mammothModule`.
        if (mammothModule && mammothModule.convertToHtml) {
          const { value: html } = await mammothModule.convertToHtml({ arrayBuffer });
          const tmp = document.createElement("div");
          tmp.innerHTML = html;
          text = tmp.innerText;
        } else if (mammothModule && mammothModule.default && mammothModule.default.convertToHtml) {
          const { value: html } = await mammothModule.default.convertToHtml({ arrayBuffer });
          const tmp = document.createElement("div");
          tmp.innerHTML = html;
          text = tmp.innerText;
        } else {
          // If import succeeded but structure unexpected, fall through to fallback loader
          throw new Error('Unexpected mammoth module shape');
        }
      } catch (err) {
        // Fallback: inject script from unpkg and use window.mammoth (UMD build)
        try {
          await loadExternalScript('https://unpkg.com/mammoth/mammoth.browser.min.js', 'mammoth');
          const arrayBuffer = await file.arrayBuffer();
          // `window.mammoth` is the UMD export; use convertToHtml
          if (window.mammoth && window.mammoth.convertToHtml) {
            const result = await window.mammoth.convertToHtml({ arrayBuffer });
            const html = result.value || '';
            const tmp = document.createElement("div");
            tmp.innerHTML = html;
            text = tmp.innerText;
          } else {
            throw new Error('mammoth not available on window after script load');
          }
        } catch (err2) {
          console.error('Failed to parse .docx using mammoth:', err, err2);
          alert('Failed to parse .docx file. Please upload a .txt file or try again.');
          return;
        }
      }
    } else {
      alert('Unsupported file type. Please upload .txt or .docx files.');
      return;
    }

    const questions = extractQuestions(text);

    if (questions
