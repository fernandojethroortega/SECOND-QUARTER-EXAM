<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Online Exam Presentation System ‚Äî PPT Download Fixed</title>

  <!-- PptxGenJS bundle (reliable browser build) -->
  <script src="https://unpkg.com/pptxgenjs@3.11.0/dist/pptxgen.bundle.js"></script>

  <style>
    body { font-family: "Segoe UI", Arial, sans-serif; background: linear-gradient(135deg,#007bff,#00c6ff); margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center; }
    .container { background:#fff; width:920px; max-width:95%; border-radius:18px; padding:36px; box-shadow:0 12px 40px rgba(0,0,0,0.18); text-align:center; }
    h2 { color:#0066cc; font-size:30px; margin:6px 0 14px; }
    pre.example { text-align:left; background:#eef8ff; padding:12px; border-radius:10px; display:inline-block; width:100%; box-sizing:border-box; font-size:15px; }
    textarea { width:100%; height:260px; margin-top:12px; padding:14px; border-radius:10px; border:1px solid #d0e7ff; font-size:18px; box-sizing:border-box; resize:vertical; }
    .btn { display:inline-block; margin:12px 8px; padding:12px 22px; border-radius:10px; border:0; cursor:pointer; background:#007bff; color:#fff; font-size:18px; font-weight:600; }
    .btn.secondary { background:#0b74ff; }
    .btn.ghost { background:#f3f6fb; color:#123; border:1px solid #dbeffd; }
    .hidden { display:none; }
    .question { font-size:30px; font-weight:700; color:#143; margin:12px 0; }
    .option { width:85%; margin:10px auto; padding:14px; border-radius:12px; background:#fbfdff; border:1px solid #e6f2ff; font-size:22px; text-align:left; }
    .timer { font-size:28px; font-weight:700; color:#c53030; margin-top:14px; }
    .controls { margin-top:20px; }
  </style>
</head>
<body>
  <div class="container" id="inputContainer">
    <h2>üìù Online Exam Generator</h2>
    <p style="font-size:16px">Paste your exam text and click <strong>Generate</strong>. Accepts question formats like <code>1. Question</code> and choices <code>A. Option</code> (also accepts 1), A), 1-, A-).</code></p>

    <pre class="example">
1. What is the capital of the Philippines?
A. Davao
B. Manila
C. Cebu
D. Baguio

2) Which planet is called the Red Planet?
A) Earth
B) Mars
C) Venus
D) Jupiter
    </pre>

    <textarea id="examText" placeholder="Paste exam text here (use 1., A. or 1), A), etc.)"></textarea>
    <div>
      <button id="generateBtn" class="btn">Generate Exam Slides</button>
      <button id="downloadPPTBtn" class="btn ghost" disabled>Download as PowerPoint</button>
    </div>
  </div>

  <div class="container hidden" id="startContainer">
    <h2>Exam Generated ‚úÖ</h2>
    <p style="font-size:16px; color:green">Slides are ready. Start presenting or download as a PowerPoint.</p>
    <div style="margin-top:14px">
      <button id="startExamBtn" class="btn">Start Exam</button>
      <button id="backBtn" class="btn ghost">Edit Text</button>
      <button id="downloadPPTBtn2" class="btn secondary">Download as PowerPoint</button>
    </div>
  </div>

  <div class="container hidden" id="examContainer">
    <div id="questionText" class="question"></div>
    <div id="optionsArea"></div>
    <div class="timer">‚è≥ Time left: <span id="timer">60</span>s</div>
    <div class="controls">
      <button id="prevBtn" class="btn ghost">‚¨Ö Previous</button>
      <button id="nextBtn" class="btn">Next ‚û°</button>
    </div>
  </div>

<script>
/* Main logic: parsing, presenting, PPT download with error handling */
(() => {
  const examTextEl = document.getElementById('examText');
  const generateBtn = document.getElementById('generateBtn');
  const downloadPPTBtn = document.getElementById('downloadPPTBtn');
  const downloadPPTBtn2 = document.getElementById('downloadPPTBtn2');
  const inputContainer = document.getElementById('inputContainer');
  const startContainer = document.getElementById('startContainer');
  const startExamBtn = document.getElementById('startExamBtn');
  const backBtn = document.getElementById('backBtn');
  const examContainer = document.getElementById('examContainer');
  const questionTextEl = document.getElementById('questionText');
  const optionsArea = document.getElementById('optionsArea');
  const timerEl = document.getElementById('timer');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');

  let questions = [];
  let currentIndex = 0;
  let timer = 60;
  let intervalID = null;

  function parseQuestions(text) {
    // Normalize and split into non-empty lines
    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l !== '');
    const parsed = [];
    let currentQ = null;

    for (const raw of lines) {
      // question patterns: 1. 1) 1- 1:
      const qMatch = raw.match(/^(\d+[\.\)\-:])\s*(.*)$/);
      // option patterns: A. A) A- A:
      const optMatch = raw.match(/^([A-Da-d][\.\)\-:])\s*(.*)$/);

      if (qMatch) {
        if (currentQ) parsed.push(currentQ);
        currentQ = { question: qMatch[2].trim(), options: [] };
      } else if (optMatch && currentQ) {
        // store with letter prefix like "A. Option text"
        const letter = optMatch[1].slice(0,1).toUpperCase();
        currentQ.options.push(`${letter}. ${optMatch[2].trim()}`);
      } else {
        // Line doesn't match q or opt:
        // If there's a current question, treat as continuation of question text.
        if (currentQ) {
          currentQ.question += ' ' + raw;
        }
      }
    }
    if (currentQ) parsed.push(currentQ);
    return parsed;
  }

  function showQuestion(index) {
    const q = questions[index];
    questionTextEl.textContent = `${index + 1}. ${q.question}`;
    optionsArea.innerHTML = '';
    for (const opt of q.options) {
      const d = document.createElement('div');
      d.className = 'option';
      d.textContent = opt;
      optionsArea.appendChild(d);
    }
    timer = 60;
    timerEl.textContent = timer;
  }

  function startCountdown() {
    clearInterval(intervalID);
    intervalID = setInterval(() => {
      timer--;
      timerEl.textContent = timer;
      if (timer <= 0) {
        goNext();
      }
    }, 1000);
  }

  function goNext() {
    if (currentIndex < questions.length - 1) {
      currentIndex++;
      showQuestion(currentIndex);
      startCountdown();
    } else {
      clearInterval(intervalID);
      questionTextEl.textContent = 'üéâ Exam Presentation Finished!';
      optionsArea.innerHTML = '';
      timerEl.textContent = '';
      prevBtn.disabled = true; nextBtn.disabled = true;
    }
  }

  function goPrev() {
    if (currentIndex > 0) {
      currentIndex--;
      showQuestion(currentIndex);
      startCountdown();
    }
  }

  // Generate button: parse and show start screen
  generateBtn.addEventListener('click', () => {
    const text = examTextEl.value.trim();
    if (!text) { alert('Please paste your exam text first.'); return; }
    questions = parseQuestions(text);
    if (!questions.length) {
      alert('No valid questions found. Use numbering (1., 2., or 1) ) and options A.-D. lines.');
      return;
    }
    // enable download button
    downloadPPTBtn.disabled = false;
    inputContainer.classList.add('hidden');
    startContainer.classList.remove('hidden');
  });

  // Back to edit
  backBtn.addEventListener('click', () => {
    startContainer.classList.add('hidden');
    inputContainer.classList.remove('hidden');
    downloadPPTBtn.disabled = true;
  });

  // Start exam
  startExamBtn.addEventListener('click', () => {
    startContainer.classList.add('hidden');
    examContainer.classList.remove('hidden');
    currentIndex = 0;
    prevBtn.disabled = false; nextBtn.disabled = false;
    showQuestion(currentIndex);
    startCountdown();
  });

  prevBtn.addEventListener('click', () => { goPrev(); });
  nextBtn.addEventListener('click', () => { goNext(); });

  // PPT generation helper
  async function generatePPT() {
    if (!questions.length) { alert('No slides available to export.'); return; }

    // Ensure library loaded
    if (typeof PptxGenJS === 'undefined') {
      alert('PowerPoint library not loaded. Check your internet connection.');
      return;
    }

    try {
      const pptx = new PptxGenJS();
      pptx.author = 'Exam Generator';
      pptx.version = '1.0';

      // Use a large, readable layout and font sizes for projection
      questions.forEach((q, i) => {
        const slide = pptx.addSlide();
        // Background (light)
        slide.background = { color: 'FFFFFF' };

        // Add question title (big)
        slide.addText(`${i + 1}. ${q.question}`, {
          x: 0.5, y: 0.4, w: 9, h: 1.6,
          fontSize: 28,
          bold: true,
          color: '003366',
          align: 'left',
          margin: 0.1
        });

        // Add options as separate text boxes with spacing
        q.options.forEach((opt, idx) => {
          slide.addText(opt, {
            x: 0.6, y: 1.6 + idx * 0.8, w: 8.8, h: 0.7,
            fontSize: 22,
            color: '000000',
            align: 'left',
            margin: 0.1
          });
        });
      });

      // Trigger download - returns a Promise
      await pptx.writeFile({ fileName: 'Exam_Presentation.pptx' });
    } catch (err) {
      console.error('PPT generation error:', err);
      alert('Failed to generate PowerPoint: ' + (err?.message || err));
    }
  }

  // Hook download buttons (two places)
  downloadPPTBtn.addEventListener('click', async () => {
    downloadPPTBtn.disabled = true;
    downloadPPTBtn.textContent = 'Preparing...';
    await generatePPT();
    downloadPPTBtn.disabled = false;
    downloadPPTBtn.textContent = 'Download as PowerPoint';
  });

  downloadPPTBtn2.addEventListener('click', async () => {
    downloadPPTBtn2.disabled = true;
    downloadPPTBtn2.textContent = 'Preparing...';
    await generatePPT();
    downloadPPTBtn2.disabled = false;
    downloadPPTBtn2.textContent = 'Download as PowerPoint';
  });

  // Keyboard navigation: left / right arrow
  document.addEventListener('keydown', (e) => {
    if (examContainer.classList.contains('hidden')) return;
    if (e.key === 'ArrowRight') goNext();
    if (e.key === 'ArrowLeft') goPrev();
    if (e.key === ' ') { // space toggles pause/start
      e.preventDefault();
      if (intervalID) { clearInterval(intervalID); intervalID = null; }
      else startCountdown();
    }
  });

})();
</script>
</body>
</html>
